# Simplified Spanwright Makefile
# Load environment variables
-include .env
export

# Default values
PROJECT_ID ?= test-project
INSTANCE_ID ?= test-instance
PRIMARY_DB_ID ?= primary-db
SECONDARY_DB_ID ?= secondary-db
DB_COUNT ?= 2
SCENARIO ?= scenario-01-basic-setup

# Docker settings
DOCKER_IMAGE ?= gcr.io/cloud-spanner-emulator/emulator
DOCKER_CONTAINER_NAME ?= spanner-emulator
DOCKER_PORT ?= 9010

.PHONY: help init clean start stop setup run-all test-e2e test-scenario-only reset-scenario-data debug-containers force-cleanup

help: ## Show this help
	@echo "Spanwright E2E Testing Framework"
	@echo "================================"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(firstword $(MAKEFILE_LIST)) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

init: ## Initialize project and check prerequisites
	@echo "ðŸš€ Initializing Spanwright project..."
	@$(MAKE) check-tools
	@$(MAKE) setup-playwright
	@echo "âœ… Project initialized successfully"

check-tools: ## Check required tools
	@echo "ðŸ” Checking required tools..."
	@command -v wrench >/dev/null 2>&1 || { echo "âŒ wrench not found"; exit 1; }
	@command -v docker >/dev/null 2>&1 || { echo "âŒ docker not found"; exit 1; }
	@command -v node >/dev/null 2>&1 || { echo "âŒ node not found"; exit 1; }
	@echo "âœ… All tools available"

setup-playwright: ## Setup Playwright
	@echo "ðŸŽ­ Setting up Playwright..."
	@npm install
	@npx playwright install
	@echo "âœ… Playwright setup complete"

start: ## Start Spanner emulator
	@echo "ðŸ³ Starting Spanner emulator..."
	@echo "ðŸ” Checking for existing containers..."
	@if docker ps -a --format '{{.Names}}' | grep -q "^$(DOCKER_CONTAINER_NAME)$$"; then \
		echo "ðŸ“¦ Existing container found, stopping and removing..."; \
		docker stop $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
		docker rm -f $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
		sleep 3; \
	fi
	@echo "ðŸ”Œ Checking port availability..."
	@if lsof -i :$(DOCKER_PORT) >/dev/null 2>&1; then \
		echo "âš ï¸ Port $(DOCKER_PORT) is still in use, waiting..."; \
		sleep 5; \
		if lsof -i :$(DOCKER_PORT) >/dev/null 2>&1; then \
			echo "âŒ Port $(DOCKER_PORT) is still occupied. Please check for other processes."; \
			exit 1; \
		fi; \
	fi
	@echo "ðŸš€ Starting new container..."
	@docker run -d --name $(DOCKER_CONTAINER_NAME) -p $(DOCKER_PORT):9010 $(DOCKER_IMAGE) >/dev/null
	@echo "â³ Waiting for emulator to be ready..."
	@sleep 3
	@echo "ðŸ” Verifying container health..."
	@for i in 1 2 3 4 5; do \
		if docker ps --format '{{.Names}}' | grep -q "^$(DOCKER_CONTAINER_NAME)$$"; then \
			echo "âœ… Container is running"; \
			break; \
		fi; \
		echo "â³ Waiting for container to start (attempt $$i/5)..."; \
		sleep 3; \
		if [ $$i -eq 5 ]; then \
			echo "âŒ Container failed to start properly"; \
			docker logs $(DOCKER_CONTAINER_NAME) 2>/dev/null || true; \
			exit 1; \
		fi; \
	done
	@sleep 12
	@echo "âœ… Spanner emulator ready on localhost:$(DOCKER_PORT)"

stop: ## Stop Spanner emulator
	@echo "ðŸ›‘ Stopping Spanner emulator..."
	@if docker ps -a --format '{{.Names}}' | grep -q "^$(DOCKER_CONTAINER_NAME)$$"; then \
		echo "ðŸ“¦ Container found, stopping..."; \
		docker stop $(DOCKER_CONTAINER_NAME) 2>/dev/null || true; \
		docker rm -f $(DOCKER_CONTAINER_NAME) 2>/dev/null || true; \
		echo "ðŸ” Verifying container removal..."; \
		sleep 2; \
		if docker ps -a --format '{{.Names}}' | grep -q "^$(DOCKER_CONTAINER_NAME)$$"; then \
			echo "âš ï¸ Container still exists, forcing removal..."; \
			docker rm -f $(DOCKER_CONTAINER_NAME) 2>/dev/null || true; \
		fi; \
	else \
		echo "ðŸ“¦ No container found to stop"; \
	fi
	@echo "âœ… Spanner emulator stopped"

clean: ## Clean up containers and artifacts
	@$(MAKE) stop
	@echo "ðŸ§¹ Cleaning build artifacts..."
	@rm -rf test-results/ playwright-report/

setup: ## Setup databases and schemas
	@echo "ðŸ—ï¸ Setting up databases..."
	@trap 'echo "ðŸš¨ Setup interrupted! Cleaning up..."; $(MAKE) stop; exit 1' INT TERM
	@$(MAKE) start
	@$(MAKE) setup-primary
ifeq ($(DB_COUNT),2)
	@$(MAKE) setup-secondary
endif
	@echo "âœ… Database setup complete"

setup-primary: ## Setup primary database
	@echo "ðŸ”¶ Setting up primary database..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_PORT) wrench instance create --project $(PROJECT_ID) --instance $(INSTANCE_ID) >/dev/null 2>&1 || true
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_PORT) wrench reset --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(PRIMARY_DB_ID) --directory "$$(pwd)/$(PRIMARY_DB_SCHEMA_PATH)" >/dev/null 2>&1 || \
	SPANNER_EMULATOR_HOST=localhost:$(DOCKER_PORT) wrench create --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(PRIMARY_DB_ID) --directory "$$(pwd)/$(PRIMARY_DB_SCHEMA_PATH)" >/dev/null 2>&1
	@echo "âœ… Primary database ready"
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_PORT) go run cmd/seed-injector/main.go --database-id $(PRIMARY_DB_ID) --fixture-dir "$$(pwd)/scenarios/$(SCENARIO)/fixtures"

setup-secondary: ## Setup secondary database
	@echo "â˜ï¸ Setting up secondary database..."
	@wrench create --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(SECONDARY_DB_ID) --directory "$(SECONDARY_SCHEMA_PATH)" --schema_file "001_*.sql"
	@go run cmd/seed-injector/main.go --database-id $(SECONDARY_DB_ID) --fixture-dir scenarios/$(SCENARIO)/fixtures

test-scenario: ## Run specific scenario test
	@echo "ðŸ§ª Running scenario: $(SCENARIO)"
	@$(MAKE) setup
	@npx playwright test --grep $(SCENARIO)

test-scenario-only: ## Run specific scenario test without setup
	@echo "ðŸ§ª Running scenario: $(SCENARIO) (no setup)"
	@npx playwright test --grep $(SCENARIO)

reset-scenario-data: ## Reset scenario data for next test
	@echo "ðŸ”„ Resetting scenario data for: $(SCENARIO)"
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_PORT) go run cmd/seed-injector/main.go --database-id $(PRIMARY_DB_ID) --fixture-dir "$$(pwd)/scenarios/$(SCENARIO)/fixtures"

run-all: run-all-scenarios ## Alias for run-all-scenarios

run-all-scenarios: ## Run all scenarios
	@echo "ðŸš€ Running all scenarios..."
	@echo "ðŸ—ï¸ Setting up once for all scenarios..."
	@trap 'echo "ðŸš¨ Interrupted! Cleaning up..."; $(MAKE) stop; exit 1' INT TERM
	@$(MAKE) setup
	@scenarios=$$(ls scenarios/ | grep -E '^(scenario|example)-'); \
	echo "ðŸ“‹ Found scenarios: $$scenarios"; \
	for scenario in $$scenarios; do \
		echo "â–¶ï¸ Running $$scenario"; \
		SCENARIO=$$scenario $(MAKE) reset-scenario-data || { echo "âŒ Failed to reset data for $$scenario"; $(MAKE) stop; exit 1; }; \
		KEEP_EMULATOR_AFTER_TESTS=true SCENARIO=$$scenario $(MAKE) test-scenario-only || { echo "âŒ Failed to run $$scenario"; $(MAKE) stop; exit 1; }; \
		echo "âœ… Completed $$scenario"; \
	done
	@echo "ðŸ§¹ Cleaning up after all scenarios..."
	@$(MAKE) stop
	@echo "âœ… All scenarios completed"

test-e2e: ## Run Playwright E2E tests
	@npx playwright test

new-scenario: ## Create new scenario (SCENARIO=name required)
	@if [ -z "$(SCENARIO)" ]; then echo "âŒ SCENARIO required"; exit 1; fi
	@echo "ðŸ“ Creating scenario: $(SCENARIO)"
	@mkdir -p scenarios/$(SCENARIO)/fixtures scenarios/$(SCENARIO)/tests
	@echo "âœ… Scenario $(SCENARIO) created"

validate: ## Validate configuration and schemas
	@echo "ðŸ” Validating configuration..."
	@test -f ".env" || { echo "âŒ .env file missing"; exit 1; }
	@test -n "$(PRIMARY_SCHEMA_PATH)" || { echo "âŒ PRIMARY_SCHEMA_PATH not set"; exit 1; }
	@test -d "$(PRIMARY_SCHEMA_PATH)" || { echo "âŒ Primary schema directory not found"; exit 1; }
ifeq ($(DB_COUNT),2)
	@test -n "$(SECONDARY_SCHEMA_PATH)" || { echo "âŒ SECONDARY_SCHEMA_PATH not set"; exit 1; }
	@test -d "$(SECONDARY_SCHEMA_PATH)" || { echo "âŒ Secondary schema directory not found"; exit 1; }
endif
	@echo "âœ… Configuration valid"

build: ## Build Go tools
	@echo "ðŸ”¨ Building Go tools..."
	@go mod tidy
	@go build -o bin/seed-injector cmd/seed-injector/main.go
	@echo "âœ… Build complete"

dev: ## Development mode - setup and watch
	@$(MAKE) setup
	@echo "ðŸ‘€ Development mode - run 'make test-e2e' to test"

debug-containers: ## Debug Docker container status
	@echo "ðŸ” Docker Container Debug Information"
	@echo "====================================="
	@echo "ðŸ“‹ All containers:"
	@docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
	@echo ""
	@echo "ðŸ” Spanner emulator containers:"
	@docker ps -a --filter "name=spanner-emulator" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
	@echo ""
	@echo "ðŸ”Œ Port usage for $(DOCKER_PORT):"
	@lsof -i :$(DOCKER_PORT) || echo "Port $(DOCKER_PORT) is free"
	@echo ""
	@echo "ðŸ“ Container logs (last 20 lines):"
	@docker logs spanner-emulator --tail 20 2>/dev/null || echo "No logs available"

force-cleanup: ## Force cleanup of all emulator containers and processes
	@echo "ðŸ§¹ Force cleanup of Spanner emulator..."
	@echo "ðŸ›‘ Stopping all spanner-emulator containers..."
	@docker ps -a --filter "name=spanner-emulator" --format "{{.Names}}" | xargs -r docker stop 2>/dev/null || true
	@docker ps -a --filter "name=spanner-emulator" --format "{{.Names}}" | xargs -r docker rm -f 2>/dev/null || true
	@echo "ðŸ”Œ Killing processes on port $(DOCKER_PORT)..."
	@lsof -ti :$(DOCKER_PORT) | xargs -r kill -9 2>/dev/null || true
	@echo "âœ… Force cleanup completed"