# Simplified Spanwright Makefile
# Load environment variables
-include .env
export

# Default values
PROJECT_ID ?= test-project
INSTANCE_ID ?= test-instance
PRIMARY_DB_ID ?= primary-db
SECONDARY_DB_ID ?= secondary-db
DB_COUNT ?= 2
SCENARIO ?= example-01-basic-setup

# Docker settings
DOCKER_IMAGE ?= gcr.io/cloud-spanner-emulator/emulator
DOCKER_CONTAINER_NAME ?= spanner-emulator
DOCKER_SPANNER_PORT ?= 9010

# Security settings
DOCKER_SECURITY_OPTS ?= --user 1000:1000 --cap-drop=ALL --cap-add=NET_BIND_SERVICE --security-opt=no-new-privileges:true
DOCKER_RESOURCE_LIMITS ?= --memory=2g --cpus=2

.PHONY: help init clean start stop setup run-all test-e2e compose-up compose-down

help: ## Show this help
	@echo "Spanwright E2E Testing Framework"
	@echo "================================"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(firstword $(MAKEFILE_LIST)) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

init: ## Initialize project and check prerequisites
	@echo "ğŸš€ Initializing Spanwright project..."
	@$(MAKE) check-tools
	@$(MAKE) setup-playwright
	@echo "âœ… Project initialized successfully"

check-tools: ## Check required tools
	@echo "ğŸ” Checking required tools..."
	@command -v wrench >/dev/null 2>&1 || { echo "âŒ wrench not found"; exit 1; }
	@command -v docker >/dev/null 2>&1 || { echo "âŒ docker not found"; exit 1; }
	@command -v node >/dev/null 2>&1 || { echo "âŒ node not found"; exit 1; }
	@$(MAKE) check-spalidate
	@echo "âœ… All tools available"

check-spalidate: ## Check spalidate availability
	@command -v spalidate >/dev/null 2>&1 || { echo "âŒ spalidate not found - install from https://github.com/nu0ma/spalidate"; exit 1; }
	@echo "âœ… spalidate available"

setup-playwright: ## Setup Playwright
	@echo "ğŸ­ Setting up Playwright..."
	@npm install
	@npx playwright install
	@echo "âœ… Playwright setup complete"

start: ## Start Spanner emulator
	@echo "ğŸ³ Starting Spanner emulator..."
	@if docker ps -a --format '{{.Names}}' | grep -q "^$(DOCKER_CONTAINER_NAME)$$"; then \
		echo "ğŸ“¦ Existing container found, restarting..."; \
		docker stop $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
		docker rm $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
	fi
	@docker run -d --name $(DOCKER_CONTAINER_NAME) \
		$(DOCKER_SECURITY_OPTS) \
		$(DOCKER_RESOURCE_LIMITS) \
		-p 127.0.0.1:$(DOCKER_SPANNER_PORT):9010 \
		$(DOCKER_IMAGE) >/dev/null
	@echo "â³ Waiting for emulator to be ready..."
	@sleep 15
	@echo "ğŸ” Verifying emulator status..."
	@if ! docker ps | grep -q $(DOCKER_CONTAINER_NAME); then echo "âŒ Emulator container not running"; exit 1; fi
	@echo "âœ… Spanner emulator ready on localhost:$(DOCKER_SPANNER_PORT)"

stop: ## Stop Spanner emulator
	@echo "ğŸ›‘ Stopping Spanner emulator..."
	@docker stop $(DOCKER_CONTAINER_NAME) 2>/dev/null || true
	@docker rm $(DOCKER_CONTAINER_NAME) 2>/dev/null || true

clean: ## Clean up containers and artifacts
	@$(MAKE) stop
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf test-results/ playwright-report/

setup: ## Setup databases and schemas
	@echo "ğŸ—ï¸ Setting up databases..."
	@$(MAKE) start
	@$(MAKE) setup-primary
ifeq ($(DB_COUNT),2)
	@$(MAKE) setup-secondary
endif
	@echo "âœ… Database setup complete"

setup-primary: ## Setup primary database
	@echo "ğŸ”¶ Setting up primary database..."
	@echo "ğŸ“¡ Creating Spanner instance $(INSTANCE_ID)..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench instance create --project $(PROJECT_ID) --instance $(INSTANCE_ID) || { echo "âŒ Failed to create Spanner instance"; exit 1; }
	@echo "ğŸ—„ï¸ Creating primary database $(PRIMARY_DB_ID)..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench reset --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(PRIMARY_DB_ID) --directory "$(PRIMARY_SCHEMA_PATH)" --schema_file "001_initial_schema.sql" 2>/dev/null || \
	SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench create --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(PRIMARY_DB_ID) --directory "$(PRIMARY_SCHEMA_PATH)" --schema_file "001_initial_schema.sql" || { echo "âŒ Failed to create primary database"; exit 1; }
	@echo "ğŸ”§ Setting up Go modules..."
	@go mod tidy >/dev/null 2>&1
	@echo "ğŸŒ± Seeding primary database..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) go run cmd/seed-injector/main.go --database-id $(PRIMARY_DB_ID) --fixture-dir "$$(pwd)/scenarios/$(SCENARIO)/fixtures/primary" || { echo "âŒ Failed to seed primary database"; exit 1; }
	@echo "âœ… Primary database ready"

setup-secondary: ## Setup secondary database
	@echo "â˜ï¸ Setting up secondary database..."
	@echo "ğŸ—„ï¸ Creating secondary database $(SECONDARY_DB_ID)..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench reset --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(SECONDARY_DB_ID) --directory "$(SECONDARY_SCHEMA_PATH)" --schema_file "001_initial_schema.sql" 2>/dev/null || \
	SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench create --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(SECONDARY_DB_ID) --directory "$(SECONDARY_SCHEMA_PATH)" --schema_file "001_initial_schema.sql" || { echo "âŒ Failed to create secondary database"; exit 1; }
	@echo "ğŸ”§ Setting up Go modules..."
	@go mod tidy >/dev/null 2>&1
	@echo "ğŸŒ± Seeding secondary database..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) go run cmd/seed-injector/main.go --database-id $(SECONDARY_DB_ID) --fixture-dir "$$(pwd)/scenarios/$(SCENARIO)/fixtures/secondary" || { echo "âŒ Failed to seed secondary database"; exit 1; }
	@echo "âœ… Secondary database ready"

test-scenario: ## Run specific scenario test  
	@echo "ğŸ§ª Running scenario: $(SCENARIO)"
	@echo "ğŸ” Verifying emulator status before tests..."
	@if ! docker ps | grep -q $(DOCKER_CONTAINER_NAME); then echo "âŒ Emulator not running"; exit 1; fi
	@echo "ğŸ­ Starting Playwright tests..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) \
	PROJECT_ID=$(PROJECT_ID) \
	INSTANCE_ID=$(INSTANCE_ID) \
	PRIMARY_DB_ID=$(PRIMARY_DB_ID) \
	SECONDARY_DB_ID=$(SECONDARY_DB_ID) \
	DB_COUNT=$(DB_COUNT) \
	npx playwright test --grep $(SCENARIO) || { echo "âŒ Playwright tests failed for $(SCENARIO)"; exit 1; }

run-all: run-all-scenarios ## Alias for run-all-scenarios

run-all-scenarios: ## Run all scenarios
	@echo "ğŸš€ Running all scenarios..."
	@echo "ğŸ“‹ Environment: PROJECT_ID=$(PROJECT_ID), INSTANCE_ID=$(INSTANCE_ID), DB_COUNT=$(DB_COUNT)"
	@$(MAKE) setup
	@scenarios=$$(ls scenarios/ | grep -E '^(scenario|example)-'); \
	if [ -z "$$scenarios" ]; then \
		echo "âŒ No scenarios found in scenarios/ directory"; \
		exit 1; \
	fi; \
	echo "ğŸ“ Found scenarios: $$scenarios"; \
	for scenario in $$scenarios; do \
		echo "â–¶ï¸ Running $$scenario"; \
		SCENARIO=$$scenario $(MAKE) test-scenario || { echo "âŒ Failed running scenario $$scenario"; exit 1; }; \
		echo "ğŸ” Validating $$scenario database state..."; \
		SCENARIO=$$scenario $(MAKE) validate-scenario || { echo "âŒ Failed validating scenario $$scenario"; exit 1; }; \
		echo "âœ… Scenario $$scenario completed successfully"; \
	done
	@echo "âœ… All scenarios completed"

test-e2e: ## Run Playwright E2E tests
	@npx playwright test

test-report: ## Open test report
	@echo "ğŸ“Š Opening test report..."
	@npx playwright show-report

validate-scenario: ## Validate scenario database state
	@if [ -z "$(SCENARIO)" ]; then echo "âŒ SCENARIO required"; exit 1; fi
	@echo "ğŸ” Validating scenario databases for $(SCENARIO)..."
	@echo "ğŸ“¡ Checking emulator status..."
	@if ! docker ps | grep -q $(DOCKER_CONTAINER_NAME); then echo "âŒ Emulator not running for validation"; exit 1; fi
	@if [ -f "scenarios/$(SCENARIO)/expected-primary.yaml" ]; then \
		echo "ğŸ” Validating primary database for $(SCENARIO)..."; \
		SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) spalidate --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(PRIMARY_DB_ID) --verbose scenarios/$(SCENARIO)/expected-primary.yaml || { echo "âŒ Primary database validation failed for $(SCENARIO)"; exit 1; }; \
	else \
		echo "âš ï¸ No primary validation file found for $(SCENARIO)"; \
	fi
ifeq ($(DB_COUNT),2)
	@if [ -f "scenarios/$(SCENARIO)/expected-secondary.yaml" ]; then \
		echo "ğŸ” Validating secondary database for $(SCENARIO)..."; \
		SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) spalidate --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(SECONDARY_DB_ID) --verbose scenarios/$(SCENARIO)/expected-secondary.yaml || { echo "âŒ Secondary database validation failed for $(SCENARIO)"; exit 1; }; \
	else \
		echo "âš ï¸ No secondary validation file found for $(SCENARIO)"; \
	fi
endif
	@echo "âœ… Database validation completed for $(SCENARIO)"

validate-db: ## Validate all databases for current scenario
	@$(MAKE) validate-scenario

new-scenario: ## Create new scenario (SCENARIO=name required)
	@if [ -z "$(SCENARIO)" ]; then echo "âŒ SCENARIO required"; exit 1; fi
	@echo "ğŸ“ Creating scenario: $(SCENARIO)"
	@mkdir -p scenarios/$(SCENARIO)/fixtures scenarios/$(SCENARIO)/tests
	@cp expected-primary.yaml.template scenarios/$(SCENARIO)/expected-primary.yaml 2>/dev/null || echo "âš ï¸ No primary template found"
ifeq ($(DB_COUNT),2)
	@cp expected-secondary.yaml.template scenarios/$(SCENARIO)/expected-secondary.yaml 2>/dev/null || echo "âš ï¸ No secondary template found"
endif
	@echo "âœ… Scenario $(SCENARIO) created"

validate: ## Validate configuration and schemas
	@echo "ğŸ” Validating configuration..."
	@test -f ".env" || { echo "âŒ .env file missing"; exit 1; }
	@test -n "$(PRIMARY_SCHEMA_PATH)" || { echo "âŒ PRIMARY_SCHEMA_PATH not set"; exit 1; }
	@test -d "$(PRIMARY_SCHEMA_PATH)" || { echo "âŒ Primary schema directory not found"; exit 1; }
ifeq ($(DB_COUNT),2)
	@test -n "$(SECONDARY_SCHEMA_PATH)" || { echo "âŒ SECONDARY_SCHEMA_PATH not set"; exit 1; }
	@test -d "$(SECONDARY_SCHEMA_PATH)" || { echo "âŒ Secondary schema directory not found"; exit 1; }
endif
	@echo "âœ… Configuration valid"

build: ## Build Go tools
	@echo "ğŸ”¨ Building Go tools..."
	@go mod tidy
	@go build -o bin/seed-injector cmd/seed-injector/main.go
	@echo "âœ… Build complete"

dev: ## Development mode - setup and watch
	@$(MAKE) setup
	@echo "ğŸ‘€ Development mode - run 'make test-e2e' to test"

compose-up: ## Start Spanner emulator using Docker Compose
	@echo "ğŸ³ Starting Spanner emulator with Docker Compose..."
	@docker-compose up -d
	@echo "â³ Waiting for emulator to be ready..."
	@sleep 15
	@echo "âœ… Spanner emulator ready on localhost:9010"

compose-down: ## Stop Spanner emulator using Docker Compose
	@echo "ğŸ›‘ Stopping Spanner emulator with Docker Compose..."
	@docker-compose down