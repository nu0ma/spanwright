# Spanwright E2E Testing Framework
-include .env
export

# Default values
PROJECT_ID ?= test-project
INSTANCE_ID ?= test-instance
PRIMARY_DB_ID ?= primary-db
SECONDARY_DB_ID ?= secondary-db
DB_COUNT ?= 2
SCENARIO ?= example-01-basic-setup
PRIMARY_SCHEMA_PATH ?= ./schema
SECONDARY_SCHEMA_PATH ?= ./schema2

# Docker settings
DOCKER_IMAGE ?= gcr.io/cloud-spanner-emulator/emulator
DOCKER_CONTAINER_NAME ?= spanner-emulator
DOCKER_SPANNER_PORT ?= 9010

.PHONY: help init start stop setup test

help: ## Show available commands
	@echo "Spanwright E2E Testing Framework"
	@echo "================================"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(firstword $(MAKEFILE_LIST)) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\\033[36m%-10s\\033[0m %s\\n", $$1, $$2}'

init: ## Initialize project and install dependencies
	@echo "ğŸš€ Initializing Spanwright project..."
	@echo "ğŸ” Checking required tools..."
	@command -v wrench >/dev/null 2>&1 || { echo "âŒ wrench not found - install from https://github.com/cloudspannerecosystem/wrench"; exit 1; }
	@command -v docker >/dev/null 2>&1 || { echo "âŒ docker not found"; exit 1; }
	@command -v node >/dev/null 2>&1 || { echo "âŒ node not found"; exit 1; }
	@command -v spalidate >/dev/null 2>&1 || { echo "âŒ spalidate not found - install from https://github.com/nu0ma/spalidate"; exit 1; }
	@echo "âœ… All tools available"
	@echo "ğŸ­ Setting up Playwright..."
	@pnpm install
	@npx playwright install
	@echo "âœ… Project initialized successfully"

start: ## Start Spanner emulator and validate tools
	@echo "ğŸ” Checking required tools..."
	@command -v wrench >/dev/null 2>&1 || { echo "âŒ wrench not found"; exit 1; }
	@command -v docker >/dev/null 2>&1 || { echo "âŒ docker not found"; exit 1; }
	@command -v node >/dev/null 2>&1 || { echo "âŒ node not found"; exit 1; }
	@command -v spalidate >/dev/null 2>&1 || { echo "âŒ spalidate not found"; exit 1; }
	@echo "âœ… All tools available"
	@echo "ğŸ³ Starting Spanner emulator..."
	@if docker ps -a --format '{{.Names}}' | grep -q "^$(DOCKER_CONTAINER_NAME)$$"; then \
		echo "ğŸ“¦ Existing container found, restarting..."; \
		docker stop $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
		docker rm $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
	fi
	@docker run -d --name $(DOCKER_CONTAINER_NAME) -p $(DOCKER_SPANNER_PORT):9010 $(DOCKER_IMAGE) >/dev/null
	@echo "â³ Waiting for emulator..."
	@max_attempts=30; attempt=0; \
	while [ $$attempt -lt $$max_attempts ]; do \
		if nc -z localhost $(DOCKER_SPANNER_PORT) 2>/dev/null; then \
			echo "âœ… Spanner emulator ready on localhost:$(DOCKER_SPANNER_PORT)"; \
			sleep 2; exit 0; \
		fi; \
		attempt=$$((attempt + 1)); sleep 1; \
	done; \
	echo "âŒ Timeout waiting for Spanner emulator"; exit 1

stop: ## Stop Spanner emulator
	@echo "ğŸ›‘ Stopping Spanner emulator..."
	@docker stop $(DOCKER_CONTAINER_NAME) 2>/dev/null || true
	@docker rm $(DOCKER_CONTAINER_NAME) 2>/dev/null || true

setup: ## Setup databases and schemas for current scenario
	@echo "ğŸ—ï¸ Setting up databases for $(SCENARIO)..."
	@$(MAKE) start >/dev/null 2>&1
	@echo "ğŸ“¡ Creating Spanner instance..."
	@SPANNER_PROJECT_ID=$(PROJECT_ID) SPANNER_INSTANCE_ID=$(INSTANCE_ID) SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench instance create 2>/dev/null || true
	@echo "ğŸ”¶ Setting up primary database..."
	@mkdir -p ./tmp && echo "-- Empty schema" > ./tmp/schema.sql
	@SPANNER_PROJECT_ID=$(PROJECT_ID) SPANNER_INSTANCE_ID=$(INSTANCE_ID) SPANNER_DATABASE_ID=$(PRIMARY_DB_ID) SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench create --directory="$$(pwd)/tmp" --schema_file=schema.sql 2>/dev/null || true
	@for file in "$(PRIMARY_SCHEMA_PATH)"/*.sql; do \
		if [ -f "$$file" ]; then \
			echo "ğŸ“„ Applying: $$file"; \
			SPANNER_PROJECT_ID=$(PROJECT_ID) SPANNER_INSTANCE_ID=$(INSTANCE_ID) SPANNER_DATABASE_ID=$(PRIMARY_DB_ID) SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench apply --ddl="$$file" || exit 1; \
		fi; \
	done
	@go mod tidy >/dev/null 2>&1
	@echo "ğŸŒ± Seeding primary database..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) go run cmd/seed-injector/main.go --database-id $(PRIMARY_DB_ID) --fixture-dir "scenarios/$(SCENARIO)/fixtures/$(PRIMARY_DB_ID)" || exit 1
ifeq ($(DB_COUNT),2)
	@echo "â˜ï¸ Setting up secondary database..."
	@SPANNER_PROJECT_ID=$(PROJECT_ID) SPANNER_INSTANCE_ID=$(INSTANCE_ID) SPANNER_DATABASE_ID=$(SECONDARY_DB_ID) SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench create --directory="$$(pwd)/tmp" --schema_file=schema.sql 2>/dev/null || true
	@for file in "$(SECONDARY_SCHEMA_PATH)"/*.sql; do \
		if [ -f "$$file" ]; then \
			echo "ğŸ“„ Applying: $$file"; \
			SPANNER_PROJECT_ID=$(PROJECT_ID) SPANNER_INSTANCE_ID=$(INSTANCE_ID) SPANNER_DATABASE_ID=$(SECONDARY_DB_ID) SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) wrench apply --ddl="$$file" || exit 1; \
		fi; \
	done
	@echo "ğŸŒ± Seeding secondary database..."
	@SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) go run cmd/seed-injector/main.go --database-id $(SECONDARY_DB_ID) --fixture-dir "scenarios/$(SCENARIO)/fixtures/$(SECONDARY_DB_ID)" || exit 1
endif
	@echo "âœ… Database setup complete for $(SCENARIO)"

test: ## Run complete E2E test workflow
	@echo "ğŸš€ Running complete E2E test workflow..."
	@$(MAKE) start >/dev/null 2>&1
	@scenarios=$$(ls scenarios/ | grep -E '^(scenario|example)-'); \
	if [ -z "$$scenarios" ]; then \
		echo "âŒ No scenarios found"; exit 1; \
	fi; \
	echo "ğŸ“ Found scenarios: $$scenarios"; \
	passed=0; failed=0; total=0; \
	for scenario in $$scenarios; do \
		total=$$((total + 1)); \
		echo ""; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		echo "ğŸ§ª SCENARIO: $$scenario"; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		if SCENARIO=$$scenario $(MAKE) setup >/dev/null 2>&1 && \
		   SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) \
		   PROJECT_ID=$(PROJECT_ID) INSTANCE_ID=$(INSTANCE_ID) \
		   PRIMARY_DB_ID=$(PRIMARY_DB_ID) SECONDARY_DB_ID=$(SECONDARY_DB_ID) \
		   DB_COUNT=$(DB_COUNT) npx playwright test --grep $$scenario && \
		   ([ ! -f "scenarios/$$scenario/expected-primary.yaml" ] || \
		    SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) spalidate \
		    --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(PRIMARY_DB_ID) \
		    scenarios/$$scenario/expected-primary.yaml) && \
		   ([ $(DB_COUNT) -ne 2 ] || [ ! -f "scenarios/$$scenario/expected-secondary.yaml" ] || \
		    SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) spalidate \
		    --project $(PROJECT_ID) --instance $(INSTANCE_ID) --database $(SECONDARY_DB_ID) \
		    scenarios/$$scenario/expected-secondary.yaml) && \
		   (SPANNER_PROJECT_ID=$(PROJECT_ID) SPANNER_INSTANCE_ID=$(INSTANCE_ID) \
		    SPANNER_DATABASE_ID=$(PRIMARY_DB_ID) SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) \
		    wrench truncate >/dev/null 2>&1 || true) && \
		   ([ $(DB_COUNT) -eq 2 ] && SPANNER_PROJECT_ID=$(PROJECT_ID) SPANNER_INSTANCE_ID=$(INSTANCE_ID) \
		    SPANNER_DATABASE_ID=$(SECONDARY_DB_ID) SPANNER_EMULATOR_HOST=localhost:$(DOCKER_SPANNER_PORT) \
		    wrench truncate >/dev/null 2>&1 || true); then \
			echo "âœ… $$scenario: PASSED"; \
			passed=$$((passed + 1)); \
		else \
			echo "âŒ $$scenario: FAILED"; \
			failed=$$((failed + 1)); \
		fi; \
	done; \
	echo ""; \
	echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
	echo "ğŸ“Š TEST RESULTS SUMMARY"; \
	echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
	echo "Total:  $$total scenarios"; \
	echo "Passed: $$passed scenarios"; \
	echo "Failed: $$failed scenarios"; \
	echo ""; \
	docker stop $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
	docker rm $(DOCKER_CONTAINER_NAME) >/dev/null 2>&1 || true; \
	if [ $$failed -gt 0 ]; then \
		echo "âŒ Some scenarios failed"; \
		exit 1; \
	else \
		echo "âœ… All scenarios passed"; \
	fi